# 在线教育平台（OEP）系统设计文档

**项目名称** | 在线教育平台（Online Education Platform）
---|---
**项目简称** | OEP
**文档版本** | 1.0
**最后更新** | 2026年2月25日
**文档类型** | 系统设计文档

---

## 目录

1. [系统架构设计](#系统架构设计)
2. [分层架构详解](#分层架构详解)
3. [数据库设计](#数据库设计)
4. [数据库表关系](#数据库表关系)
5. [关键功能模块设计](#关键功能模块设计)
6. [接口设计](#接口设计)
7. [业务流程实现](#业务流程实现)
8. [架构模式与设计原则](#架构模式与设计原则)
9. [扩展与部署](#扩展与部署)
10. [性能优化策略](#性能优化策略)

---

## 系统架构设计

### 1.1 总体架构

OEP系统采用**标准的前后端分离三层架构**，结合**MVC设计模式**，具有以下特点：

```
┌─────────────────────────────────────────────────────────┐
│                    前端应用层(Presentation)             │
│  Vue3 + Element Plus + Responsive Design                │
│  - 学生/教师/管理员多端UI                                │
│  - 路由管理(46个路由)                                    │
│  - 状态管理(localStorage + Context)                      │
│  - 富文本编辑(TinyMCE + Quill)                          │
│  - 数据可视化(ECharts + Chart.js)                       │
└─────────────────────┬───────────────────────────────────┘
                      │
                 HTTP/REST API
                 (Port 8080/HTTPS)
                      │
┌─────────────────────▼───────────────────────────────────┐
│           中间件层(Middleware & SDK)                    │
│  - Spring Security 权限认证                             │
│  - JWT Token 会话管理                                   │
│  - CORS 跨域资源共享                                    │
│  - 异常处理与日志                                      │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────┐
│           应用业务层(Application)                       │
│  Spring Boot 2.7.6 + MyBatis Plus 3.5.2                 │
│  - 9个Controller模块                                    │
│  - 9个Service/ServiceImpl模块                            │
│  - 24个Mapper接口                                       │
│  - 40+个Model实体类                                     │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────┐
│           数据持久层(Persistence)                       │
│  MyBatis Plus + SQL Mapper                              │
│  - 参数化查询(防止SQL注入)                              │
│  - 动态SQL生成                                         │
│  - 二级缓存支持                                        │
│  - 逻辑删除支持                                        │
└─────────────────────┬───────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────┐
│             数据库层(Database)                          │
│  MySQL 8.0+ (oepdb)                                    │
│  - 32个数据表                                          │
│  - 关系型数据模型                                      │
│  - 索引优化                                            │
│  - 定期备份机制                                        │
└─────────────────────────────────────────────────────────┘
```

### 1.2 核心设计原则

1. **分离关注点（Separation of Concerns）**
   - Controller处理HTTP请求和响应
   - Service处理业务逻辑
   - Mapper处理数据访问
   - 各层职责清晰

2. **依赖注入（Dependency Injection）**
   - 使用构造器注入注入依赖
   - 便于单元测试和组件替换

3. **RESTful设计**
   - 面向资源的API设计
   - 使用HTTP方法表达操作语义
   - 统一响应格式

4. **单一责任原则（Single Responsibility）**
   - 每个类只负责一项职责
   - Service实现类只处理特定模块业务

5. **开闭原则（Open-Closed Principle）**
   - 模块化设计便于扩展
   - 新功能可通过添加新的Service/Controller实现

---

## 分层架构详解

### 2.1 表示层（Presentation Layer）

#### 2.1.1 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Vue | 3.4.15 | 核心框架 |
| Vite | 5.0.11 | 构建工具 |
| Vue Router | 4.2.5 | 路由管理 |
| Axios | 1.6.7 | HTTP客户端 |
| Element Plus | 2.6.0 | UI组件库 |
| ECharts | 5.5.0 | 图表库 |
| TinyMCE Vue | 5.1.1 | 富文本编辑 |

#### 2.1.2 路由体系

**路由管理（46条路由）：**
- 完整的路由树结构
- 基于用户角色的动态路由
- 权限守卫（Auth Guard）
- Token缓存管理（localStorage）

**典型路由结构：**
```
/                          (根路由)
├── /login                 (登录页)
├── /student               (学生模块)
│   ├── /course           (课程列表)
│   ├── /course/:id       (课程详情)
│   ├── /exam             (考试列表)
│   ├── /task             (作业列表)
│   └── /statistics       (统计分析)
├── /teacher              (教师模块)
│   ├── /course           (课程管理)
│   ├── /question-bank    (题库管理)
│   ├── /exam-paper       (试卷管理)
│   └── /grade            (批改评分)
└── /admin                (管理员模块)
    ├── /user-manage      (用户管理)
    ├── /course-audit     (课程审批)
    └── /system-log       (系统日志)
```

#### 2.1.3 状态管理

**数据存储策略：**
- **localStorage**：持久化用户信息、Token、用户偏好
- **sessionStorage**：临时数据（当前页面会话）
- **组件State**：页面局部状态
- **globalData**：(可选) 使用Vuex/Context管理全局状态

**Token管理：**
```javascript
// Token存储位置
localStorage.setItem('token', 'Bearer xxx');

// 请求拦截器自动附加Token
axios.interceptors.request.use(config => {
    config.headers.Authorization = localStorage.getItem('token');
    return config;
});
```

### 2.2 应用层（Application Layer）

#### 2.2.1 Controller层设计

**设计模式：**
- **RESTful API设计**：资源导向
- **请求映射**：@PostMapping, @GetMapping
- **参数绑定**：@RequestBody, @RequestParam, @PathVariable
- **统一响应**：返回R对象

**示例结构：**
```java
@RestController
@RequestMapping("/exam")
public class ExamController {
    @Autowired
    private ExamService examService;

    @PostMapping("/create")
    public R createExamPaper(@RequestBody Map<String, Object> requestData) {
        Boolean ret = examService.createExam(requestData);
        return ret ? R.ok() : R.error();
    }
}
```

**9个主要Controller模块：**

| Controller | 基础路径 | 职责 |
|-----------|---------|------|
| UserController | /user | 用户认证、登录 |
| CourseController | /course | 课程管理 |
| QuestionController | /question | 题目管理 |
| ExamController | /exam | 考试管理 |
| TaskController | /task | 作业管理 |
| ClassController | /class | 班级管理 |
| FolderController | /folder | 文件夹/分类管理 |
| NoticeController | /notice | 通知公告 |
| ManageController | /manage | 系统管理 |

#### 2.2.2 统一响应格式（R类）

**R类设计：**
```java
public class R extends HashMap<String, Object> {
    // 成功响应
    {
        "code": 20000,
        "msg": "success",
        "data": {...}
    }

    // 错误响应
    {
        "code": 20001,
        "msg": "用户名或密码错误",
        "data": null
    }
}
```

**状态码定义：**
| 状态码 | 含义 | 说明 |
|-------|------|------|
| 20000 | 成功 | 操作成功完成 |
| 20001 | 认证失败 | 用户名密码错误 |
| 20002 | 用户被禁用 | 账户被管理员禁用 |
| 500 | 服务器错误 | 内部异常 |

### 2.3 业务逻辑层（Business Logic Layer）

#### 2.3.1 Service接口与实现

**设计特点：**
- 每个功能模块对应一个Service接口和ServiceImpl实现
- 使用构造器注入Mapper依赖
- 业务逻辑与数据访问分离

**Service层包含的9个模块：**

1. **UserService** - 用户业务逻辑
   ```java
   public interface UserService {
       User login(String id, String password);
   }
   ```
   - 密码验证使用PasswordEncoder
   - 记录登录日志

2. **CourseService** - 课程相关
   - 创建课程、编辑课程
   - 上传课程封面和资源
   - 建立课程与班级关联

3. **ExamService** - 考试相关
   - 创建试卷、自动组卷
   - 发布考试、管理答卷
   - 自动批改客观题、记录分数

4. **TaskService** - 作业相关
   - 创建作业、发布作业
   - 学生提交作业
   - 教师批改评分

5. **QuestionService** - 题库相关
   - 创建题目、编辑题目
   - 题库分类管理
   - 题目导入导出

6. **ClassService** - 班级相关
   - 班级创建管理
   - 学生分配到班级

7. **FolderService** - 文件夹相关
   - 资源文件管理
   - 文件上传下载

8. **NoticeService** - 通知相关
   
- 发布通知、管理通知
   
9. **ManageService** - 系统管理
   - 用户管理、权限管理
   - 日志查询

#### 2.3.2 核心业务实现模式

**例子：考试提交流程**
```java
@Override
public Boolean submitExamPaper(Map<String, Object> requestData) {
    // Step 1: 验证参数
    int paperId = (Integer) requestData.get("paperId");
    String studentId = (String) requestData.get("studentId");
    List<AnswerRecord> answers = (List) requestData.get("answers");

    // Step 2: 查询答题记录
    ExamRecord examRecord = examRecordMapper.selectById(paperId);

    // Step 3: 保存学生答案
    for (AnswerRecord answer : answers) {
        answerRecordMapper.insert(answer);
    }

    // Step 4: 自动评分客观题
    autoGradeObjectiveQuestions(paperId, studentId);

    // Step 5: 更新考试记录状态
    examRecord.setStatus("submitted");
    examRecordMapper.updateById(examRecord);

    // Step 6: 记录日志
    systemLogMapper.insert(createLog("学生提交试卷", studentId));

    return true;
}
```

### 2.4 数据访问层（Data Access Layer）

#### 2.4.1 Mapper设计

**Mapper继承结构：**
```java
public interface UserMapper extends BaseMapper<User> {
    // 继承BaseMapper的CRUD方法：
    // - insert(User)
    // - selectById(id)
    // - updateById(User)
    // - deleteById(id)
    // - selectList/Page/Map

    // 自定义方法
    List<User> selectStudent(int classId, int courseId);
    List<User> selectStudentByClass(int classId);
    void disabledUser(String userId);
    void enableUser(String userId);
}
```

**24个Mapper接口覆盖：**
- UserMapper - 用户数据访问
- CourseMapper - 课程数据访问
- QuestionMapper - 题目数据访问
- ExamPaperMapper - 试卷数据访问
- ExamRecordMapper - 考试记录
- AnswerRecordMapper - 答题记录
- TaskMapper - 作业数据访问
- TaskRecordMapper - 作业提交记录
- 以及其他关联表Mapper

#### 2.4.2 MyBatis Plus特性利用

**BaseMapper提供的通用CRUD方法：**
```java
// 插入
int insert(T entity);

// 查询
T selectById(Serializable id);
List<T> selectBatchIds(Collection<? extends Serializable> idList);
List<T> selectByMap(Map<String, Object> columnMap);
List<T> selectList(Wrapper<T> queryWrapper);
Page<T> selectPage(Page<T> page, Wrapper<T> queryWrapper);

// 更新
int updateById(T entity);
int update(T entity, Wrapper<T> updateWrapper);

// 删除
int deleteById(Serializable id);
int deleteByMap(Map<String, Object> columnMap);
int delete(Wrapper<T> queryWrapper);
```

#### 2.4.3 参数化查询与防注入

**使用方式：**
```java
// 正确：参数化查询（防止SQL注入）
QueryWrapper<User> queryWrapper = new QueryWrapper<>();
queryWrapper.eq("id", userId).eq("state", 1);
User user = userMapper.selectOne(queryWrapper);

// 禁止：字符串拼接（易被注入）
// String sql = "SELECT * FROM tb_user WHERE id = '" + userId + "'";
```

---

## 数据库设计

### 3.1 数据库总体设计

**数据库名称：** oepdb
**字符集：** UTF-8
**存储引擎：** InnoDB
**总表数：** 32个

**设计原则：**
- 遵循第三范式（3NF）
- 合理使用外键约束
- 适当建立索引优化查询
- 支持事务ACID特性

### 3.2 核心表结构

#### 3.2.1 用户与组织体系

**tb_user（用户表）**
```sql
CREATE TABLE tb_user (
    id VARCHAR(32) PRIMARY KEY COMMENT '用户ID(学号/工号)',
    name VARCHAR(100) COMMENT '用户姓名',
    password VARCHAR(255) COMMENT '密码(BCrypt加密)',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '电话',
    state INT COMMENT '账户状态: 1=启用, 0=禁用',
    type INT COMMENT '用户类型: 0=学生, 1=教师, 2=管理员',
    sid INT COMMENT '学校ID',
    pid INT COMMENT '部门ID',
    FOREIGN KEY (sid) REFERENCES tb_school(id),
    FOREIGN KEY (pid) REFERENCES tb_department(id),
    INDEX idx_type (type),
    INDEX idx_state (state),
    INDEX idx_sid_pid (sid, pid)
);
```

**tb_school（学校表）**
```sql
CREATE TABLE tb_school (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) UNIQUE COMMENT '学校名称'
);
```

**tb_department（部门表）**
```sql
CREATE TABLE tb_department (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(100) COMMENT '部门名称',
    sid INT COMMENT '学校ID',
    FOREIGN KEY (sid) REFERENCES tb_school(id),
    INDEX idx_sid (sid)
);
```

#### 3.2.2 课程体系

**tb_course（课程表）**
```sql
CREATE TABLE tb_course (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) COMMENT '课程名称',
    uid VARCHAR(32) COMMENT '课程创建者(教师ID)',
    sid INT COMMENT '学校ID',
    pid INT COMMENT '部门ID',
    descr TEXT COMMENT '课程描述',
    cover VARCHAR(255) COMMENT '课程封面路径',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (uid) REFERENCES tb_user(id),
    INDEX idx_uid_sid (uid, sid),
    FULLTEXT INDEX ftx_name (name)
);
```

**tb_chapter（章节表）**
```sql
CREATE TABLE tb_chapter (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) COMMENT '章节名称',
    courseid INT COMMENT '课程ID',
    ordernum INT COMMENT '章节顺序号',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (courseid) REFERENCES tb_course(id) ON DELETE CASCADE,
    INDEX idx_courseid_order (courseid, ordernum)
);
```

**tb_content（学习内容表）**
```sql
CREATE TABLE tb_content (
    id INT PRIMARY KEY AUTO_INCREMENT,
    chapterid INT COMMENT '章节ID',
    name VARCHAR(255) COMMENT '内容标题',
    content LONGTEXT COMMENT '内容正文(HTML)',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    updatetime DATETIME ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (chapterid) REFERENCES tb_chapter(id) ON DELETE CASCADE,
    INDEX idx_chapterid (chapterid)
);
```

**tb_course_class（课程班级关联表）**
```sql
CREATE TABLE tb_course_class (
    id INT PRIMARY KEY AUTO_INCREMENT,
    courseid INT COMMENT '课程ID',
    classid INT COMMENT '班级ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (courseid) REFERENCES tb_course(id) ON DELETE CASCADE,
    FOREIGN KEY (classid) REFERENCES tb_class(id) ON DELETE CASCADE,
    UNIQUE KEY uk_courseid_classid (courseid, classid),
    INDEX idx_classid (classid)
);
```

**tb_student_class（学生班级关联表）**
```sql
CREATE TABLE tb_student_class (
    id INT PRIMARY KEY AUTO_INCREMENT,
    sid VARCHAR(32) COMMENT '学生ID',
    classid INT COMMENT '班级ID',
    jointime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (sid) REFERENCES tb_user(id),
    FOREIGN KEY (classid) REFERENCES tb_class(id) ON DELETE CASCADE,
    UNIQUE KEY uk_sid_classid (sid, classid),
    INDEX idx_classid (classid)
);
```

#### 3.2.3 题库与题目体系

**tb_question（题目表）**
```sql
CREATE TABLE tb_question (
    id INT PRIMARY KEY AUTO_INCREMENT,
    type VARCHAR(20) COMMENT '题目类型: single/multi/judge/blank/short',
    level VARCHAR(20) COMMENT '难度: easy/medium/hard',
    content TEXT COMMENT '题目内容',
    answer TEXT COMMENT '标准答案',
    option1 TEXT COMMENT '选项1',
    option2 TEXT COMMENT '选项2',
    option3 TEXT COMMENT '选项3',
    option4 TEXT COMMENT '选项4',
    folderid INT COMMENT '分类ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    creator VARCHAR(32) COMMENT '创建者ID',
    questiontype INT COMMENT '题型分类',
    dirty INT DEFAULT 0 COMMENT '删除标记',
    courseid INT COMMENT '所属课程ID',
    FOREIGN KEY (creator) REFERENCES tb_user(id),
    FOREIGN KEY (courseid) REFERENCES tb_course(id),
    FOREIGN KEY (folderid) REFERENCES tb_folder(id),
    INDEX idx_type (type),
    INDEX idx_level (level),
    INDEX idx_courseid (courseid),
    INDEX idx_dirty (dirty),
    FULLTEXT INDEX ftx_content (content)
);
```

**tb_folder（题库分类/文件夹表）**
```sql
CREATE TABLE tb_folder (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) COMMENT '分类名称',
    pid INT DEFAULT 0 COMMENT '父分类ID(支持嵌套)',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_pid (pid)
);
```

#### 3.2.4 考试体系

**tb_exampaper（试卷表）**
```sql
CREATE TABLE tb_exampaper (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) COMMENT '试卷名称',
    score INT COMMENT '总分值',
    count INT COMMENT '题目数量',
    level VARCHAR(20) COMMENT '试卷难度',
    courseid INT COMMENT '课程ID',
    creator VARCHAR(32) COMMENT '创建者ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    type VARCHAR(20) COMMENT '试卷类型: auto/manual',
    folderid INT COMMENT '分类ID',
    sealflag INT DEFAULT 0 COMMENT '封存标记: 1=已封存, 0=未封存',
    password VARCHAR(255) COMMENT '封存密码',
    FOREIGN KEY (courseid) REFERENCES tb_course(id),
    FOREIGN KEY (creator) REFERENCES tb_user(id),
    INDEX idx_courseid (courseid),
    INDEX idx_creator (creator),
    INDEX idx_createtime (createtime)
);
```

**tb_paper_question（试卷题目关联表）**
```sql
CREATE TABLE tb_paper_question (
    id INT PRIMARY KEY AUTO_INCREMENT,
    paperid INT COMMENT '试卷ID',
    questionid INT COMMENT '题目ID',
    number INT COMMENT '试卷版本号(用于随机卷)',
    questionorder INT COMMENT '题目在试卷中的顺序',
    FOREIGN KEY (paperid) REFERENCES tb_exampaper(id) ON DELETE CASCADE,
    FOREIGN KEY (questionid) REFERENCES tb_question(id),
    INDEX idx_paperid_number (paperid, number),
    INDEX idx_questionid (questionid),
    UNIQUE KEY uk_paperid_questionid_number (paperid, questionid, number)
);
```

**tb_exam_paper_release（试卷发布表）**
```sql
CREATE TABLE tb_exam_paper_release (
    id INT PRIMARY KEY AUTO_INCREMENT,
    paperid INT COMMENT '试卷ID',
    classid INT COMMENT '班级ID',
    starttime DATETIME COMMENT '考试开始时间',
    endtime DATETIME COMMENT '考试结束时间',
    duration INT COMMENT '考试时长(分钟)',
    status VARCHAR(20) COMMENT '发布状态: draft/published/closed',
    creator VARCHAR(32) COMMENT '发布者ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (paperid) REFERENCES tb_exampaper(id),
    FOREIGN KEY (classid) REFERENCES tb_class(id),
    FOREIGN KEY (creator) REFERENCES tb_user(id),
    INDEX idx_paperid_classid (paperid, classid),
    INDEX idx_status (status),
    INDEX idx_endtime (endtime)
);
```

**tb_exam_record（考试记录表）**
```sql
CREATE TABLE tb_exam_record (
    id INT PRIMARY KEY AUTO_INCREMENT,
    sid VARCHAR(32) COMMENT '学生ID',
    sname VARCHAR(100) COMMENT '学生姓名',
    paperid INT COMMENT '试卷ID',
    classid INT COMMENT '班级ID',
    starttime DATETIME COMMENT '开始答卷时间',
    endtime DATETIME COMMENT '结束答卷时间',
    status VARCHAR(20) COMMENT '答卷状态: draft/submitted/reviewed',
    score DECIMAL(5,2) COMMENT '得分',
    number INT COMMENT '随机卷版本号',
    FOREIGN KEY (sid) REFERENCES tb_user(id),
    FOREIGN KEY (paperid) REFERENCES tb_exampaper(id),
    FOREIGN KEY (classid) REFERENCES tb_class(id),
    INDEX idx_sid_paperid (sid, paperid),
    INDEX idx_paperid_classid (paperid, classid),
    INDEX idx_status (status),
    INDEX idx_endtime (endtime)
);
```

**tb_answer_record（答题记录表）**
```sql
CREATE TABLE tb_answer_record (
    id INT PRIMARY KEY AUTO_INCREMENT,
    examrecordid INT COMMENT '考试记录ID',
    questionid INT COMMENT '题目ID',
    studentanswer TEXT COMMENT '学生答案',
    isright INT COMMENT '答案是否正确',
    score DECIMAL(5,2) COMMENT '得分',
    answertime DATETIME COMMENT '答题时间',
    FOREIGN KEY (examrecordid) REFERENCES tb_exam_record(id) ON DELETE CASCADE,
    FOREIGN KEY (questionid) REFERENCES tb_question(id),
    INDEX idx_examrecordid (examrecordid),
    INDEX idx_questionid (questionid)
);
```

#### 3.2.5 作业体系

**tb_task（作业表）**
```sql
CREATE TABLE tb_task (
    id INT PRIMARY KEY AUTO_INCREMENT,
    name VARCHAR(255) COMMENT '作业标题',
    score INT COMMENT '总分值',
    courseid INT COMMENT '课程ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    creator VARCHAR(32) COMMENT '创建者ID',
    type VARCHAR(20) COMMENT '作业类型',
    folderid INT COMMENT '分类ID',
    FOREIGN KEY (courseid) REFERENCES tb_course(id),
    FOREIGN KEY (creator) REFERENCES tb_user(id),
    INDEX idx_courseid (courseid),
    INDEX idx_creator (creator)
);
```

**tb_task_release（作业发布表）**
```sql
CREATE TABLE tb_task_release (
    id INT PRIMARY KEY AUTO_INCREMENT,
    taskid INT COMMENT '作业ID',
    classid INT COMMENT '班级ID',
    starttime DATETIME COMMENT '发布时间',
    endtime DATETIME COMMENT '截止时间',
    status VARCHAR(20) COMMENT '发布状态',
    creator VARCHAR(32) COMMENT '发布者ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (taskid) REFERENCES tb_task(id),
    FOREIGN KEY (classid) REFERENCES tb_class(id),
    FOREIGN KEY (creator) REFERENCES tb_user(id),
    INDEX idx_taskid_classid (taskid, classid),
    INDEX idx_status (status),
    INDEX idx_endtime (endtime)
);
```

**tb_task_record（学生作业记录表）**
```sql
CREATE TABLE tb_task_record (
    id INT PRIMARY KEY AUTO_INCREMENT,
    taskid INT COMMENT '作业ID',
    sid VARCHAR(32) COMMENT '学生ID',
    sname VARCHAR(100) COMMENT '学生姓名',
    status VARCHAR(20) COMMENT '提交状态: draft/submitted/reviewed',
    submittime DATETIME COMMENT '提交时间',
    score DECIMAL(5,2) COMMENT '得分',
    comment TEXT COMMENT '教师评语',
    FOREIGN KEY (taskid) REFERENCES tb_task(id),
    FOREIGN KEY (sid) REFERENCES tb_user(id),
    INDEX idx_taskid_sid (taskid, sid),
    INDEX idx_status (status),
    INDEX idx_submittime (submittime)
);
```

**tb_task_question（作业题目关联表）**
```sql
CREATE TABLE tb_task_question (
    id INT PRIMARY KEY AUTO_INCREMENT,
    taskid INT COMMENT '作业ID',
    questionid INT COMMENT '题目ID',
    questionorder INT COMMENT '题目顺序',
    FOREIGN KEY (taskid) REFERENCES tb_task(id) ON DELETE CASCADE,
    FOREIGN KEY (questionid) REFERENCES tb_question(id),
    INDEX idx_taskid (taskid)
);
```

**tb_task_answer_record（作业答题记录表）**
```sql
CREATE TABLE tb_task_answer_record (
    id INT PRIMARY KEY AUTO_INCREMENT,
    taskrecordid INT COMMENT '作业记录ID',
    questionid INT COMMENT '题目ID',
    studentanswer TEXT COMMENT '学生答案',
    score DECIMAL(5,2) COMMENT '得分',
    answertime DATETIME COMMENT '答题时间',
    FOREIGN KEY (taskrecordid) REFERENCES tb_task_record(id) ON DELETE CASCADE,
    FOREIGN KEY (questionid) REFERENCES tb_question(id),
    INDEX idx_taskrecordid (taskrecordid)
);
```

#### 3.2.6 其他表

**tb_notice（通知表）**
```sql
CREATE TABLE tb_notice (
    id INT PRIMARY KEY AUTO_INCREMENT,
    title VARCHAR(255) COMMENT '通知标题',
    content TEXT COMMENT '通知内容',
    courseid INT COMMENT '课程ID(0=系统通知)',
    creator VARCHAR(32) COMMENT '发布者ID',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    importance INT COMMENT '重要程度',
    istop INT DEFAULT 0 COMMENT '是否置顶',
    FOREIGN KEY (courseid) REFERENCES tb_course(id),
    FOREIGN KEY (creator) REFERENCES tb_user(id),
    INDEX idx_courseid (courseid),
    INDEX idx_createtime (createtime),
    FULLTEXT INDEX ftx_content (content)
);
```

**tb_system_log（系统日志表）**
```sql
CREATE TABLE tb_system_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    uid VARCHAR(32) COMMENT '用户ID',
    action VARCHAR(100) COMMENT '操作动作',
    actiontype VARCHAR(50) COMMENT '操作类型',
    content TEXT COMMENT '详细内容',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    ipaddress VARCHAR(20) COMMENT 'IP地址',
    operationresult VARCHAR(50) COMMENT '操作结果',
    FOREIGN KEY (uid) REFERENCES tb_user(id),
    INDEX idx_uid (uid),
    INDEX idx_createtime (createtime),
    INDEX idx_actiontype (actiontype)
);
```

**tb_course_log（课程日志表）**
```sql
CREATE TABLE tb_course_log (
    id INT PRIMARY KEY AUTO_INCREMENT,
    courseid INT COMMENT '课程ID',
    uid VARCHAR(32) COMMENT '用户ID',
    action VARCHAR(100) COMMENT '操作',
    createtime DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (courseid) REFERENCES tb_course(id),
    FOREIGN KEY (uid) REFERENCES tb_user(id),
    INDEX idx_courseid (courseid),
    INDEX idx_createtime (createtime)
);
```

### 3.3 数据库索引策略

**索引建立原则：**
1. 主键自动创建唯一索引
2. 外键列建立普通索引
3. 频繁查询条件建立索引
4. WHERE子句中的列建立索引
5. JOIN关联字段建立索引

**常见查询的索引优化：**

| 查询场景 | 建议索引 | 原因 |
|---------|--------|------|
| 按课程ID查询 | idx_courseid | 课程是主要维度 |
| 按学生ID查询 | idx_sid | 学生相关数据 |
| 按时间范围查询 | idx_createtime | 时间过滤 |
| 多条件查询 | 联合索引 | 避免全表扫描 |
| 排序查询 | 与排序列相同的索引 | 避免排序操作 |

### 3.4 数据库容量规划

**预期数据规模（中等教育机构）：**
- 学生数：5000人
- 教师数：500人
- 课程数：200门
- 题目数：10000道
- 考试次数：年50000次
- 作业提交：年500000次

**存储估算：**
- 用户表：~5MB
- 课程内容：~1GB（包含视频链接等）
- 题目表：~500MB
- 考试记录：~2GB
- 日志表：~5GB（1年）
- **总体：约10-15GB**

---

## 数据库表关系

### 4.1 E-R图（实体关系图）

**主要关系：**

```
┌─────────────┐
│  tb_school  │
└──────┬──────┘
       │ 1
       │
       │ N
    ┌──▼──────────────────┐
    │  tb_department       │
    │  tb_user (sid,pid)   │
    └──┬───────────────────┘
       │
       │ N
    ┌──▼──────────────┐
    │  tb_course       │
    │  (sid, pid, uid) │
    └──┬──────────────┘
       │ N
    ┌──┴────────────────────────┐
    │  tb_chapter                │
    │  tb_content                │
    │  tb_course_class           │
    │  tb_question (courseid)    │
    │  tb_exampaper (courseid)   │
    │  tb_task (courseid)        │
    └────────────────────────────┘


┌────────────────────┐
│  tb_exampaper      │
│  (考试)            │
└──┬────────┬────────┘
   │        │
   │ N      │ N
┌──▼──┐  ┌──▼──────────────────┐
│tb_  │  │  tb_exam_paper_     │
│paper│  │  release            │
│ques │  │  (classid)          │
│tion │  └──┬───────────────────┘
└─────┘     │ N
            │
         ┌──▼──────────────┐
         │  tb_exam_record │
         │  (sid, paperid) │
         └──┬──────────────┘
            │ N
         ┌──▼────────────────┐
         │ tb_answer_record   │
         │ (examrecordid,     │
         │  questionid)       │
         └────────────────────┘


┌────────────────────┐
│   tb_task          │
│   (作业)           │
└──┬────────┬────────┘
   │        │
   │ N      │ N
┌──▼──┐  ┌──▼──────────────────┐
│tb_  │  │  tb_task_release    │
│task │  │  (classid)          │
│ques │  └──┬───────────────────┘
│tion │     │ N
└─────┘  ┌──▼──────────────┐
         │  tb_task_record │
         │  (sid, taskid)  │
         └──┬──────────────┘
            │ N
         ┌──▼────────────────┐
         │ tb_task_answer_    │
         │ record             │
         └────────────────────┘


┌──────────────────┐
│  tb_student_     │
│  class           │
│  (sid,classid)   │
└──────────────────┘


└──────────────────┐
│  tb_course_class │
│  (courseid,      │
│   classid)       │
└──────────────────┘
```

### 4.2 关键关系说明

**一对多关系：**
- 学校 → 部门、用户
- 课程 → 章节、内容、试卷、作业
- 试卷 → 试卷题目、试卷发布、答题记录
- 作业 → 作业题目、作业发布、答题记录

**多对多关系：**
- 课程 ↔ 班级 (tb_course_class)
- 学生 ↔ 班级 (tb_student_class)
- 试卷 ↔ 题目 (tb_paper_question)
- 作业 ↔ 题目 (tb_task_question)

**关键外键约束：**
```sql
-- 级联删除：删除课程时删除该课程的所有章节
ALTER TABLE tb_chapter ADD CONSTRAINT fk_course
  FOREIGN KEY (courseid) REFERENCES tb_course(id) ON DELETE CASCADE;

-- 级联删除：删除试卷时删除该试卷的所有题目关联
ALTER TABLE tb_paper_question ADD CONSTRAINT fk_paper
  FOREIGN KEY (paperid) REFERENCES tb_exampaper(id) ON DELETE CASCADE;
```

---

## 关键功能模块设计

### 5.1 用户认证模块设计

#### 5.1.1 登录流程

```
┌─────────────┐
│ 用户输入     │
│用户名/密码   │
└──────┬──────┘
       │
       ▼
┌─────────────────────┐
│ 前端表单验证        │
│ (必填项、格式等)    │
└──────┬──────────────┘
       │
       ▼
┌──────────────────────────────┐
│ POST /user/login              │
│ {id, password}               │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│ UserController.login()       │
│ - 参数提取与验证             │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│ UserService.login()          │
│ - 查询用户信息               │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│ PasswordEncoder.matches()    │
│ - 密码验证(BCrypt)          │
└──────┬───────────────────────┘
       │
       ├─── 密码错误 ──→ 返回错误(20001)
       │
       └─── 密码正确 ──→ 检查账户状态
            │
            ├─── state=0(禁用) ──→ 返回错误(20002)
            │
            └─── state=1(启用) ──→ ┐
                                   │
                                   ▼
                        ┌──────────────────────┐
                        │ SystemLogMapper      │
                        │ 记录登录日志         │
                        └──────┬───────────────┘
                               │
                               ▼
                        ┌──────────────────────┐
                        │ 返回User对象         │
                        │ + JWT Token(可选)    │
                        └──────────────────────┘
```

#### 5.1.2 实现细节

**密码加密存储：**
```java
// 配置类中定义PasswordEncoder
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}

// 注册用户时加密密码
@Service
public class UserServiceImpl {
    @Autowired
    private PasswordEncoder passwordEncoder;

    public void registerUser(User user) {
        String encryptedPassword = passwordEncoder.encode(user.getPassword());
        user.setPassword(encryptedPassword);
        userMapper.insert(user);
    }
}

// 登录时验证密码
public User login(String id, String password) {
    User user = userMapper.selectById(id);

    // 使用matches方法比较密码
    if (user != null && passwordEncoder.matches(password, user.getPassword())) {
        // 记录日志
        recordLoginLog(id);
        return user;
    }
    return null;
}
```

**权限拦截器（建议添加）：**
```java
@Component
public class AuthInterceptor implements HandlerInterceptor {
    @Override
    public boolean preHandle(HttpServletRequest request,
                             HttpServletResponse response,
                             Object handler) throws Exception {
        String token = request.getHeader("Authorization");

        // 验证Token有效性
        if (isValidToken(token)) {
            return true;
        }

        response.setStatus(401);
        return false;
    }
}
```

### 5.2 课程管理模块设计

#### 5.2.1 课程创建流程

```
教师端：
┌─────────────────────┐
│ 输入课程基本信息    │
│ - 课程名称          │
│ - 描述信息          │
│ - 上传封面          │
└──────┬──────────────┘
       │
       ▼
┌─────────────────────┐
│ POST /course/create │
│ (multipart表单)     │
└──────┬──────────────┘
       │
       ▼
┌──────────────────────────────┐
│ CourseController.create()    │
│ - 文件上传处理               │
│ - 参数绑定                   │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│ CourseService.createCourse() │
│ - 生成课程对象               │
│ - 调用Mapper插入             │
│ - 记录日志                   │
└──────┬───────────────────────┘
       │
       ▼
┌──────────────────────────────┐
│ 返回成功信息                 │
│ 课程进入待审批状态           │
└──────────────────────────────┘

管理员端：
┌─────────────────────────────┐
│ 查看待审批课程列表          │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 审批课程                    │
│ - 审核内容                  │
│ - 通过/驳回                 │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│ 课程发布                    │
│ 学生可见此课程              │
└─────────────────────────────┘
```

#### 5.2.2 章节内容结构

**tb_chapter和tb_content的设计：**
```
课程(Course)
└── 章节1(Chapter 1)
    ├── 内容1(Content 1) - 文本/视频链接
    ├── 内容2(Content 2) - PDF文档
    ├── 内容3(Content 3) - HTML页面
    └── ...
└── 章节2(Chapter 2)
    ├── 内容1(Content 1)
    ├── 内容2(Content 2)
    └── ...
└── ...
```

**前端展示树形结构：**
```javascript
// Vue组件中使用树形结构展示
<el-tree
  :data="courseStructure"
  node-key="id"
  :props="{ children: 'children', label: 'name' }">
</el-tree>

// courseStructure数据结构
[
  {
    id: 1,
    name: '第一章 绪论',
    children: [
      { id: 101, name: '1.1 课程介绍', type: 'content' },
      { id: 102, name: '1.2 学习目标', type: 'content' }
    ]
  },
  ...
]
```

### 5.3 考试模块设计

#### 5.3.1 自动组卷算法

**组卷参数：**
- 总分值（如100分）
- 题目数量（如50题）
- 难度分布（如易20%、中60%、难20%）
- 题型分布（如单选30%、多选20%等）

**算法步骤：**
```java
public List<Question> autoGeneratePaperQuestions(
    int courseId, int totalScore, int questionCount,
    Map<String, Double> difficultyRatio,
    Map<String, Integer> typeRatio) {

    // Step 1: 按难度分类查询题目
    List<Question> easyQuestions = questionMapper.selectByDifficulty("easy", courseId);
    List<Question> mediumQuestions = questionMapper.selectByDifficulty("medium", courseId);
    List<Question> hardQuestions = questionMapper.selectByDifficulty("hard", courseId);

    // Step 2: 按比例计算各难度需要的题目数
    int easyCount = (int) (questionCount * difficultyRatio.get("easy"));
    int mediumCount = (int) (questionCount * difficultyRatio.get("medium"));
    int hardCount = (int) (questionCount * difficultyRatio.get("hard"));

    // Step 3: 随机抽取
    List<Question> selectedQuestions = new ArrayList<>();
    selectedQuestions.addAll(selectRandomly(easyQuestions, easyCount));
    selectedQuestions.addAll(selectRandomly(mediumQuestions, mediumCount));
    selectedQuestions.addAll(selectRandomly(hardQuestions, hardCount));

    // Step 4: 按题型混合（确保题型分布）
    List<Question> shuffledQuestions = shuffleByType(selectedQuestions, typeRatio);

    // Step 5: 保存到数据库
    ExamPaper paper = new ExamPaper();
    paper.setScore(totalScore);
    paper.setCount(questionCount);
    examPaperMapper.insert(paper);

    // 插入题目关联
    for (Question q : shuffledQuestions) {
        PaperQuestion pq = new PaperQuestion();
        pq.setPaperid(paper.getId());
        pq.setQuestionid(q.getId());
        paperQuestionMapper.insert(pq);
    }

    return shuffledQuestions;
}
```

#### 5.3.2 考试答题流程

```
学生端：
┌─────────────────────────┐
│ 查看可参加考试列表      │
│ GET /exam/selectExamPaper
│ (courseId, studentId)   │
└──────┬──────────────────┘
       │ 返回试卷基本信息
       ▼
┌─────────────────────────┐
│ 点击"进入考试"          │
└──────┬──────────────────┘
       │
       ▼
┌────────────────────────────────┐
│ 系统验证:                       │
│ - 检查考试是否在有效时间内     │
│ - 检查学生是否属于该班级       │
│ - 检查学生是否已提交过答卷     │
└──────┬─────────────────────────┘
       │
       ├─── 验证失败 ──→ 显示错误信息
       │
       └─── 验证成功 ──→ ┐
                        │
                        ▼
        ┌─────────────────────────────┐
        │ POST /exam/getExamPaper     │
        │ 生成随机试卷                │
        │ - 生成随机试卷编号(number)  │
        │ - 按照该编号查询题目        │
        │ - 创建ExamRecord记录        │
        │ - 返回Q uestionEx1列表      │
        └─────────┬───────────────────┘
                  │
                  ▼
        ┌─────────────────────────────┐
        │ 前端显示试卷                │
        │ - 倒计时                    │
        │ - 题目列表                  │
        │ - 自动保存(定时)            │
        └─────────┬───────────────────┘
                  │
                  ▼
        ┌─────────────────────────────┐
        │ 学生答题 ↔ 自动保存        │
        │ - 定时保存答案到localSt...  │
        │ - 提交前最终确认            │
        └─────────┬───────────────────┘
                  │
                  ├─── 时间到自动收卷
                  │
                  └─── 学生主动提交 ──→ ┐
                                        │
                                        ▼
                        ┌────────────────────────┐
                        │ POST /exam/submitExam  │
                        │ Paper                  │
                        └──────┬─────────────────┘
                               │
                               ▼
                        ┌────────────────────────┐
                        │ ExamService.submit()   │
                        │ - 保存所有答案         │
                        │ - 自动评分(客观题)     │
                        │ - 计算总分             │
                        │ - 更新答卷状态         │
                        │ - 记录系统日志         │
                        └──────┬─────────────────┘
                               │
                               ▼
                        ┌────────────────────────┐
                        │ 返回提交成功信息       │
                        │ 学生可查看初步成绩     │
                        └────────────────────────┘

教师端（批改）：
┌────────────────────────────┐
│ 查看考试答卷列表           │
│ GET /exam/selectByExamId   │
│ (paperId, classId)         │
└──────┬─────────────────────┘
       │ 显示所有学生答卷
       ▼
┌────────────────────────────┐
│ 选择学生答卷批改           │
│ 查看:                      │
│ - 学生答案                 │
│ - 自动评分结果             │
│ - 主观题反馈               │
└──────┬─────────────────────┘
       │
       ▼
┌────────────────────────────┐
│ 批改主观题                 │
│ - 评定分数(0-100)         │
│ - 输入评语/反馈            │
└──────┬─────────────────────┘
       │
       ▼
┌────────────────────────────┐
│ POST /exam/updateReviewRec │
│ ord                        │
│ 提交批改结果               │
└──────┬─────────────────────┘
       │
       ▼
┌────────────────────────────┐
│ 学生可查看最终成绩和评语   │
└────────────────────────────┘
```

#### 5.3.3 自动评分逻辑

```java
public void autoGradeObjectiveQuestions(int paperId, String studentId) {
    // 获取该学生答卷的所有答题记录
    List<AnswerRecord> answerRecords = answerRecordMapper
        .selectByExamRecordIdAndQuestionType(paperId, studentId,
            new String[]{"single", "multi", "judge"});

    double totalScore = 0;

    for (AnswerRecord answer : answerRecords) {
        Question question = questionMapper.selectById(answer.getQuestionid());

        // 对比标准答案
        if (answer.getStudentanswer().equals(question.getAnswer())) {
            answer.setIsright(1);
            // 获取该题分值(根据题目在试卷中的分值)
            PaperQuestion pq = paperQuestionMapper
                .selectByPaperIdAndQuestionId(paperId, answer.getQuestionid());
            double questionScore = pq.getQuestionScore();
            answer.setScore(questionScore);
            totalScore += questionScore;
        } else {
            answer.setIsright(0);
            answer.setScore(0);
        }

        // 更新答题记录
        answerRecordMapper.updateById(answer);
    }

    // 更新答卷总分(加上主观题得分)
    ExamRecord examRecord = examRecordMapper.selectByStudentIdAndPaperId(studentId, paperId);
    examRecord.setScore(examRecord.getScore() + totalScore);
    examRecordMapper.updateById(examRecord);
}
```

### 5.4 作业模块设计

#### 5.4.1 作业生命周期

```
┌──────────────────────┐
│ 1. 创建阶段          │
├──────────────────────┤
│ 教师创建作业         │
│ - 输入作业标题、要求 │
│ - 添加题目到作业     │
│ - 设置总分值         │
│ 状态: draft（草稿）  │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 2. 发布阶段          │
├──────────────────────┤
│ 教师发布作业         │
│ - POST /task/release │
│ - 选择发布班级       │
│ - 设置截止时间       │
│ 状态: published      │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 3. 提交阶段          │
├──────────────────────┤
│ 学生在线作答         │
│ - 查看作业详情       │
│ - 完成题目答题       │
│ - 保存草稿           │
│ 状态: draft（未提）  │
└──────┬───────────────┘
       │
       ├─── 未到截止时间
       │    │
       │    └─→ 学生提交作业
       │         │
       │         ▼
       │   ┌──────────────────┐
       │   │ 状态: submitted  │
       │   │ (已提交待批改)   │
       │   └──────┬───────────┘
       │          │
       │ 非截止时间限制已过
       │          │
       │          ▼
       └────► ┌──────────────────┐
               │ 状态: overdue    │
               │ (逾期提交)       │
               └──────┬───────────┘
                      │
                      ▼
         ┌──────────────────────────┐
         │ 4. 批改阶段              │
         ├──────────────────────────┤
         │ 教师批改学生作业         │
         │ - POST /task/reviewTask  │
         │ - 评定分数               │
         │ - 输入批改评语           │
         │ 状态: reviewed(已批改)   │
         └──────┬───────────────────┘
                │
                ▼
         ┌──────────────────────────┐
         │ 5. 完成阶段              │
         ├──────────────────────────┤
         │ 学生查看成绩和评语       │
         │ 作业流程完成             │
         └──────────────────────────┘
```

---

## 接口设计

### 6.1 API设计原则

1. **RESTful风格：**
   - 使用HTTP方法表达操作语义
   - 资源导向的URL设计
   - 合理使用HTTP状态码

2. **统一响应格式：**
   - 所有API返回R对象
   - 包含code、msg、data三个字段
   - 状态码统一定义

3. **版本管理：**
   - URL中包含版本号（建议）
   - /api/v1/user/login
   - /api/v2/exam/create

### 6.2 关键API设计示例

**POST /user/login - 用户登录**
```
请求：
{
    "id": "student001",
    "password": "password123"
}

响应（成功）：
{
    "code": 20000,
    "msg": "success",
    "data": {
        "id": "student001",
        "name": "张三",
        "type": 0,
        "state": 1,
        "token": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
    }
}

响应（失败）：
{
    "code": 20001,
    "msg": "用户名或密码错误",
    "data": null
}
```

**POST /exam/submitExamPaper - 学生提交试卷**
```
请求：
{
    "paperId": 101,
    "studentId": "student001",
    "answers": [
        {
            "questionId": 1001,
            "studentAnswer": "A",
            "answerTime": "2024-01-15 10:30:45"
        },
        ...
    ]
}

响应（成功）：
{
    "code": 20000,
    "msg": "success",
    "data": {
        "examRecordId": 5001,
        "preliminaryScore": 85.5,
        "message": "答卷已提交，客观题自动评分完成"
    }
}
```

### 6.3 分页查询API设计

**GET /course/list - 分页获取课程列表**
```
请求：
/course/list?page=1&pageSize=10&status=published

响应：
{
    "code": 20000,
    "msg": "success",
    "data": {
        "total": 45,
        "pageNum": 1,
        "pageSize": 10,
        "pages": 5,
        "list": [
            {
                "id": 1,
                "name": "Java高级特性",
                "teacher": "李老师",
                "studentCount": 234,
                ...
            },
            ...
        ]
    }
}
```

---

## 业务流程实现

### 7.1 核心业务流程实现

#### 7.1.1 考试完整流程的代码实现

**ExamServiceImpl核心方法：**
```java
@Service
public class ExamServiceImpl implements ExamService {
    // 依赖注入
    private ExamPaperMapper examPaperMapper;
    private PaperQuestionMapper paperQuestionMapper;
    private QuestionMapper questionMapper;
    private ExamRecordMapper examRecordMapper;
    private AnswerRecordMapper answerRecordMapper;
    private SystemLogMapper systemLogMapper;

    // 构造器注入
    public ExamServiceImpl(ExamPaperMapper examPaperMapper, ...) {
        this.examPaperMapper = examPaperMapper;
        ...
    }

    /**
     * 自动创建试卷
     */
    @Override
    public Boolean createExam(Map<String, Object> requestData) {
        // 解析参数
        String examName = (String) requestData.get("examName");
        int totalScore = (Integer) requestData.get("totalScore");
        int questionCount = (Integer) requestData.get("questionCount");
        int courseId = (Integer) requestData.get("courseId");
        String userId = (String) requestData.get("userId");

        // 创建试卷对象
        ExamPaper examPaper = new ExamPaper();
        examPaper.setName(examName);
        examPaper.setScore(totalScore);
        examPaper.setCount(questionCount);
        examPaper.setCourseid(courseId);
        examPaper.setCreator(userId);
        examPaper.setCreatetime(UtilTools.getCurrentTime());
        examPaper.setSealflag(0);

        // 插入试卷
        examPaperMapper.insert(examPaper);
        int paperId = examPaper.getId();

        // 自动组卷
        autoGenerateQuestions(paperId, courseId, questionCount);

        // 记录系统日志
        SystemLog log = new SystemLog();
        log.setUserid(userId);
        log.setDate(UtilTools.getCurrentTime());
        log.setDescr("创建试卷: " + examName);
        systemLogMapper.insert(log);

        return true;
    }

    /**
     * 学生提交试卷
     */
    @Override
    public Boolean submitExamPaper(Map<String, Object> requestData) {
        int paperId = (Integer) requestData.get("paperId");
        String studentId = (String) requestData.get("studentId");
        List<Map<String, Object>> answerList =
            (List<Map<String, Object>>) requestData.get("answers");

        // 查询答卷记录
        ExamRecord examRecord = examRecordMapper
            .selectByStudentIdAndPaperId(studentId, paperId);

        // 保存所有答题记录
        for (Map<String, Object> answer : answerList) {
            int questionId = (Integer) answer.get("questionId");
            String studentAnswer = (String) answer.get("studentAnswer");

            AnswerRecord record = new AnswerRecord();
            record.setExamrecordid(examRecord.getId());
            record.setQuestionid(questionId);
            record.setStudentanswer(studentAnswer);
            record.setAnswertime(new Timestamp(System.currentTimeMillis()));

            answerRecordMapper.insert(record);
        }

        // 自动评分客观题
        autoGradeObjectiveQuestions(examRecord.getId());

        // 更新答卷状态
        examRecord.setStatus("submitted");
        examRecord.setEndtime(new Timestamp(System.currentTimeMillis()));
        examRecordMapper.updateById(examRecord);

        return true;
    }

    /**
     * 自动评分客观题
     */
    private void autoGradeObjectiveQuestions(int examRecordId) {
        List<AnswerRecord> answerRecords =
            answerRecordMapper.selectByExamRecordId(examRecordId);

        double totalScore = 0;

        for (AnswerRecord answer : answerRecords) {
            Question question = questionMapper.selectById(answer.getQuestionid());

            // 只自动评分客观题
            if (isObjectiveQuestion(question.getType())) {
                boolean isCorrect = answer.getStudentanswer()
                    .equalsIgnoreCase(question.getAnswer());
                answer.setIsright(isCorrect ? 1 : 0);
                answer.setScore(isCorrect ? getQuestionScore(answer.getQuestionid()) : 0);
                totalScore += answer.getScore();
            }

            answerRecordMapper.updateById(answer);
        }

        // 更新答卷总分
        ExamRecord examRecord = examRecordMapper.selectById(examRecordId);
        examRecord.setScore(totalScore);
        examRecordMapper.updateById(examRecord);
    }

    /**
     * 教师批改主观题
     */
    @Override
    public boolean teacherRating(Map<String, Object> requestData) {
        int answerId = (Integer) requestData.get("answerId");
        double score = ((Number) requestData.get("score")).doubleValue();
        String comment = (String) requestData.get("comment");

        // 更新答题记录
        AnswerRecord answer = answerRecordMapper.selectById(answerId);
        answer.setScore(score);
        answer.setComment(comment);
        answer.setIsright(score > 0 ? 1 : 0);
        answerRecordMapper.updateById(answer);

        // 重新计算答卷总分
        recalculateExamScore(answer.getExamrecordid());

        return true;
    }
}
```

---

## 架构模式与设计原则

### 8.1 使用的设计模式

| 模式 | 应用场景 | 示例 |
|------|---------|------|
| **MVC模式** | 整体架构 | Controller-Service-Mapper分层 |
| **单一职责** | 类设计 | UserService只处理用户业务 |
| **依赖注入** | 组件协作 | 构造器注入Mapper和Service |
| **工厂模式** | 对象创建 | Spring容器管理Bean创建 |
| **模板方法** | 重复逻辑 | BaseMapper提供通用CRUD |
| **策略模式** | 多种算法 | 自动组卷的不同策略 |
| **观察者模式** | 事件处理 | Spring事件监听(可选) |
| **装饰器模式** | 功能增强 | 权限验证、日志记录 |

### 8.2 SOLID原则应用

**1. Single Responsibility Principle (单一职责)**
- UserService只处理用户相关业务
- ExamService只处理考试相关业务
- 各Service职责明确

**2. Open/Closed Principle (开闭原则)**
- 对扩展开放：可添加新的Service实现
- 对修改关闭：现有代码无需修改

**3. Liskov Substitution Principle (里氏替换)**
- Service接口可被任何实现类替换
- Mapper继承BaseMapper保证兼容性

**4. Interface Segregation Principle (接口隔离)**
- 每个Service接口只包含相关的方法
- 避免强制实现无关的方法

**5. Dependency Inversion Principle (依赖倒置)**
- 依赖抽象(接口)而非具体实现
- 使用构造器注入依赖

### 8.3 事务处理

**关键操作的事务处理：**
```java
@Service
@Transactional
public class ExamServiceImpl implements ExamService {

    /**
     * 创建试卷及其题目关联 - 需要事务保证原子性
     */
    @Override
    @Transactional
    public Boolean createExam(Map<String, Object> requestData) {
        try {
            // Step 1: 插入试卷
            examPaperMapper.insert(examPaper);

            // Step 2: 插入试卷题目关联
            for (Question question : questions) {
                PaperQuestion pq = new PaperQuestion();
                // ...
                paperQuestionMapper.insert(pq);
            }

            // Step 3: 记录日志
            systemLogMapper.insert(log);

            // 如果任何一步失败，所有操作都会回滚
            return true;
        } catch (Exception e) {
            // 事务自动回滚
            log.error("创建试卷失败", e);
            throw new RuntimeException("创建试卷失败");
        }
    }
}
```

---

## 扩展与部署

### 9.1 系统扩展方向

#### 9.1.1 短期扩展（1-3个月）
1. **增强用户管理**
   - 用户头像管理
   - 用户个人资料完善
   - 密码修改/重置功能

2. **题库功能完善**
   - 题目导入导出(Excel)
   - 题目收藏/标签功能
   - 出题建议(根据学生学习数据)

3. **考试功能增强**
   - 部分分题(多选题部分正确给分)
   - 考试禁用复制功能
   - 考试成绩统计图表优化

#### 9.1.2 中期扩展（3-6个月）
1. **实时互动**
   - WebSocket实时通知
   - 班级讨论功能
   - 师生互动评论

2. **学习路径规划**
   - 个性化学习推荐
   - 学习路线设计
   - 学习进度预测

3. **数据分析增强**
   - 热力图（学生强弱点）
   - 学习行为分析
   - 教学效果评估

#### 9.1.3 长期扩展（6个月+）
1. **人工智能应用**
   - 智能仓库试卷生成
   - 自动阅卷系统(OCR)
   - 个性化学习推荐(机器学习)

2. **移动应用**
   - iOS/Android App开发
   - 离线学习支持

3. **第三方集成**
   - 成绩导入到学生管理系统
   - SSO单点登录
   - 教学资源库对接

### 9.2 部署架构

#### 9.2.1 开发环境部署
```
开发者本地：
├── JDK 8+
├── MySQL 8.0
├── Node.js 16+
└── IDE (IntelliJ IDEA / VSCode)
```

#### 9.2.2 生产环境部署

**推荐架构（中等规模）：**
```
┌─────────────────────────────────────────┐
│   终端用户(学生/教师/管理员)            │
├─────────────────────────────────────────┤
│   互联网 (HTTPS)                        │
├──────────┬──────────────────────────────┤
│  Nginx   │ (反向代理 + 负载均衡)         │
├──────────┴──────────────────────────────┤
│  ┌───────────────┐  ┌────────────────┐  │
│  │ Spring Boot   │  │ CDN 静态资源   │  │
│  │ Instance 1    │  │ (前端打包文件)  │  │
│  └───────────────┘  └────────────────┘  │
│  ┌───────────────┐                      │
│  │ Spring Boot   │                      │
│  │ Instance 2    │                      │
│  └───────┬───────┘                      │
├──────────┴──────────────────────────────┤
│  ┌───────────────────────────────────┐  │
│  │  MySQL 主库 (oepdb)               │  │
│  │  - 表空间优化                     │  │
│  │  - 索引维护                       │  │
│  │  - 自动备份                       │  │
│  └───────┬─────────────────┬─────────┘  │
│          │                 │             │
│    ┌─────▼─────┐     ┌────▼─────┐      │
│    │ 主从复制  │     │ 旁路备份  │      │
│    │ (从库)    │     │ (备份库)  │      │
│    └───────────┘     └──────────┘      │
├───────────────────────────────────────┤
│  监控和日志系统(可选)                 │
│  - Prometheus监控                     │
│  - ELK日志分析                        │
│  - 告警机制                           │
└───────────────────────────────────────┘
```

#### 9.2.3 Docker容器化部署

**Dockerfile示例：**
```dockerfile
# 后端镜像
FROM openjdk:8-jre-alpine
WORKDIR /app
COPY target/OnlineEducationPlatform.jar app.jar
EXPOSE 8080
ENTRYPOINT ["java", "-jar", "app.jar"]

# 前端镜像
FROM node:16-alpine as builder
WORKDIR /app
COPY . .
RUN npm install && npm run build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
EXPOSE 80
```

**Docker Compose编排：**
```yaml
version: '3.8'
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: 123456
      MYSQL_DATABASE: oepdb
    volumes:
      - mysql-data:/var/lib/mysql
    ports:
      - "3306:3306"

  backend:
    build: ./OnlineEducationPlatform
    ports:
      - "8080:8080"
    depends_on:
      - mysql
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/oepdb

  frontend:
    build: ./OnlineEducationPlatform-web
    ports:
      - "80:80"
    depends_on:
      - backend

volumes:
  mysql-data:
```

---

## 性能优化策略

### 10.1 数据库优化

#### 10.1.1 索引优化
```sql
-- 为频繁查询的列建立索引
CREATE INDEX idx_user_type ON tb_user(type);
CREATE INDEX idx_course_id ON tb_course(id);

-- 复合索引优化多条件查询
CREATE INDEX idx_exam_record_composite
  ON tb_exam_record(sid, paperid, classid);

-- 为排序操作建立索引
CREATE INDEX idx_createtime ON tb_course(createtime DESC);
```

#### 10.1.2 查询优化
```java
// 优化前：N+1查询问题
List<Course> courses = courseMapper.selectAll();
for (Course course : courses) {
    User teacher = userMapper.selectById(course.getUid()); // N次查询
}

// 优化后：一次查询获取关联数据
List<CourseEx> coursesEx = courseMapper.selectListWithTeacher();
// SQL中使用LEFT JOIN
```

#### 10.1.3 连接池配置
```yaml
spring:
  datasource:
    # HikariCP连接池配置
    hikari:
      maximum-pool-size: 20       # 最大连接数
      minimum-idle: 5             # 最少空闲连接
      connection-timeout: 30000   # 连接超时时间
      idle-timeout: 600000        # 空闲超时时间
```

### 10.2 缓存策略

#### 10.2.1 Redis缓存（可选）
```java
@Service
public class CourseServiceImpl {
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;

    public Course getCourse(int courseId) {
        // 先查缓存
        String key = "course:" + courseId;
        Course course = (Course) redisTemplate.opsForValue().get(key);

        if (course != null) {
            return course;
        }

        // 缓存未命中，查数据库
        course = courseMapper.selectById(courseId);

        // 写入缓存(5分钟过期)
        redisTemplate.opsForValue().set(key, course, Duration.ofMinutes(5));

        return course;
    }
}
```

#### 10.2.2 业务缓存
```javascript
// 前端缓存学生的课程列表
// 使用localStorage减少API调用
class StudentCourseService {
    static getCourses() {
        // 先检查缓存
        const cached = localStorage.getItem('studentCourses');
        if (cached) {
            return JSON.parse(cached);
        }

        // 调用API
        return fetch('/api/course/list').then(res => {
            const courses = res.json();
            // 缓存5分钟
            localStorage.setItem('studentCourses', JSON.stringify(courses));
            // 5分钟后清除缓存
            setTimeout(() => {
                localStorage.removeItem('studentCourses');
            }, 5 * 60 * 1000);
            return courses;
        });
    }
}
```

### 10.3 代码性能优化

#### 10.3.1 批量操作优化
```java
// 优化前：逐条插入
for (Question question : questions) {
    questionMapper.insert(question);  // 多次数据库往返
}

// 优化后：批量插入
questionMapper.batchInsert(questions);  // 一次数据库操作
```

#### 10.3.2 异步处理
```java
@Service
public class ExamServiceImpl {
    @Autowired
    private TaskExecutor taskExecutor;

    public Boolean submitExamPaper(Map<String, Object> requestData) {
        // ... 保存答卷记录

        // 异步执行自动评分和日志记录
        taskExecutor.execute(() -> {
            autoGradeObjectiveQuestions(examRecordId);
            recordSystemLog(userId, "提交试卷");
        });

        return true;  // 立即返回
    }
}
```

### 10.4 前端性能优化

#### 10.4.1 代码分割
```javascript
// 路由级别的代码分割
const router = createRouter({
    routes: [
        {
            path: '/student/exam',
            component: () => import('./views/StudentAnsweringView.vue')
        },
        {
            path: '/teacher/grade',
            component: () => import('./views/TeacherGradingView.vue')
        }
    ]
});
```

#### 10.4.2 图片lazy加载

```html
<!-- 使用v-lazy指令延迟加载 -->
<img v-lazy="course.coverUrl" class="course-cover">

<!-- 或使用原生lazy属性 -->
<img :src="course.coverUrl" loading="lazy">
```

#### 10.4.3 虚拟列表优化
```javascript
// 用于显示大量题目/学生列表
// 使用vue-virtual-scroller库
<virtual-scroller :items="questions" :item-size="50">
    <template v-slot="{ item }">
        <div class="question-item">{{ item.content }}</div>
    </template>
</virtual-scroller>
```

---

**文档发布日期：** 2026年2月25日
**版本：** 1.0
**状态：** 完成

---
